rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isOrgMember(orgId) {
      return exists(/databases/$(database)/documents/organizations/$(orgId)/users/$(request.auth.uid));
    }

    function getRole(orgId) {
      return get(/databases/$(database)/documents/organizations/$(orgId)/users/$(request.auth.uid)).data.role;
    }

    function isOrgOwner(orgId) {
      return get(/databases/$(database)/documents/organizations/$(orgId)).data.ownerId == request.auth.uid;
    }

    // Organizations can be read by their members, and created by any authenticated user.
    // Only the owner can update or delete an organization.
    match /organizations/{orgId} {
      allow read: if isOrgMember(orgId);
      allow create: if request.auth != null && request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if isOrgOwner(orgId);

      // Users can be managed by organization admins.
      // A user can always view their own user document.
      match /users/{userId} {
        allow read: if request.auth.uid == userId || (isOrgMember(orgId) && getRole(orgId) == 'admin');
        allow create: if request.auth.uid == userId;
        allow update, delete: if isOrgMember(orgId) && getRole(orgId) == 'admin';
      }

      // Clients can be viewed by any org member.
      // Clients can be created, updated, or deleted by admins or sales roles.
      match /clients/{clientId} {
        allow read: if isOrgMember(orgId);
        allow write: if isOrgMember(orgId) && getRole(orgId) in ['admin', 'sales'];
      }
    }
  }
}
