rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isOrgMember(orgId) {
      return exists(/databases/$(database)/documents/organizations/$(orgId)/users/$(request.auth.uid));
    }

    function getRole(orgId) {
      return get(/databases/$(database)/documents/organizations/$(orgId)/users/$(request.auth.uid)).data.role;
    }

    function isOrgOwner(orgId) {
      return get(/databases/$(database)/documents/organizations/$(orgId)).data.ownerId == request.auth.uid;
    }

    // Organizations can be read by their members, and created by any authenticated user.
    // Only the owner can update or delete an organization.
    match /organizations/{orgId} {
      allow read: if isOrgMember(orgId);
      allow create: if request.auth != null && request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if isOrgOwner(orgId);

      // Users can be managed by organization admins.
      // Users can view their own data.
      // A user can create their own user document as part of joining an organization.
      match /users/{userId} {
        allow read: if isOrgMember(orgId) && (getRole(orgId) == 'admin' || request.auth.uid == userId);
        allow create: if request.auth.uid == userId;
        allow update, delete: if isOrgMember(orgId) && getRole(orgId) == 'admin';
      }

      // Clients can be managed by admins and sales roles.
      // Other org members can view clients.
      match /clients/{clientId} {
        allow read, write: if isOrgMember(orgId) && getRole(orgId) in ['admin', 'sales', 'it', 'finance'];
      }
    }
  }
}
